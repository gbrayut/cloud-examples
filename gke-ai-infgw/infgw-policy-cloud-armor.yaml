# Apply Cloud Armor WAF policy to GKE Inference Gateway https://cloud.google.com/kubernetes-engine/docs/how-to/configure-gateway-resources#configure_cloud_armor
# Changes should be visible in Load Balancers and Backends section at https://console.cloud.google.com/net-services/loadbalancing/list/loadBalancers
apiVersion: networking.gke.io/v1
kind: GCPBackendPolicy
metadata:
  name: vllm-gemma-3-1b   # Name must match value generated by helm chart to override it, otherwise duplicate policy won't get applied
spec:
  default:
    # Copy values from helm chart https://github.com/kubernetes-sigs/gateway-api-inference-extension/blob/9a2667c2853c0883c8d340f25e35b204dc970604/config/charts/inferencepool/templates/gke.yaml
    timeoutSec: 300    # 5-minute timeout (adjust as needed)
    logging:
      enabled: true    # log all requests by default

    securityPolicy: uc1-security-policy   # See gke-gclb-misc/cloud-armor/README.md for example regional Cloud Armor policy
  targetRef:
    group: "inference.networking.x-k8s.io"
    kind: InferencePool
    name: vllm-gemma-3-1b   # Cloud Armor rule should only apply to this InferencePool instance, but seems to apply to all InferencePool instances
---
## Second policy to cover 4b Inference Pool (Currently not needed since above seem to apply to all InferencePool resources)
#apiVersion: networking.gke.io/v1
#kind: GCPBackendPolicy
#metadata:
#  name: vllm-gemma-3-4b
#spec:
#  default:
#    timeoutSec: 300    # 5-minute timeout (adjust as needed)
#    logging:
#      enabled: true    # log all requests by default
#
#    securityPolicy: uc1-security-policy
#  targetRef:
#    group: "inference.networking.x-k8s.io"
#    kind: InferencePool
#    name: vllm-gemma-3-4b



#
# Expected result when action is deny-403
#

#< HTTP/1.1 403 Forbidden
#< content-type: text/html; charset=UTF-8
#< content-length: 134
#< x-infgw-selected: infp-gemma3-1b
#< date: Thu, 24 Jul 2025 21:47:04 GMT
#< via: 1.1 google
#< 
#* Connection #0 to host api.example.com left intact
#<!doctype html><meta charset="utf-8"><meta name=viewport content="width=device-width, initial-scale=1"><title>403</title>403 Forbidden
